# Database Schema Migration Guide

This guide walks you through the process of updating the database schema using Alembic migrations.

## Prerequisites

**Alembic installed**: Ensure Alembic is installed. It should already by configured in the project. If not, install it:

```bash
pip install alembic
```

**Shared Base**: All models must use the shared base from `models/base.py`

```python
from models.base import Base  # Import shared base
class UserORM(Base):
```

**Environment**: Check the `config.ini` file to ensure you're working in the correct environment (dev/prod). The database connection will be configured in `alembic/env.py` using the same `config.ini` file that the Lambda function uses.

## Step-by-Step Migration Process

### Step 1: Modify SQLAlchemy Models

Update your ORM models in the `models/` directory to reflect the desired schema changes:

```python
# Example: Adding a new column to UserORM
class UserORM(Base):
    __tablename__ = 'users'
    
    id: Mapped[str] = mapped_column(primary_key=True)
    username: Mapped[str] = mapped_column(nullable=False, unique=True)
    password: Mapped[str] = mapped_column(nullable=False)
    full_name: Mapped[str] = mapped_column(nullable=False)
    email: Mapped[str] = mapped_column(nullable=True)  # New column
    enabled: Mapped[bool] = mapped_column(default=True)
    role: Mapped[str] = mapped_column(default="user")
```

### Step 2: Generate Migration

Create a new migration file based on your model changes:

```bash
alembic revision --autogenerate -m "Add email column to users table"
```

This generates a migration file in `alembic/versions/` with a descriptive name.

### Step 3: Review Generated Migration

Open the generated migration file and review the changes:

```python
# Example generated migration
def upgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    op.add_column('users', sa.Column('email', sa.String(), nullable=True))
    # ### end Alembic commands ###

def downgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    op.drop_column('users', 'email')
    # ### end Alembic commands ###
```

**Important**: Always review auto-generated migrations! You may need to:
- Add data transformations for existing records
- Handle complex schema changes manually
- Add custom SQL for data migration

### Step 4: Apply Migration

Apply the migration to your development database:

```bash
alembic upgrade head
```

Verify the changes in your database and test your application.

## Common Migration Scenarios

### Adding a New Table

1. Create the new ORM model inheriting from the shared `Base`
2. Import the model in your application or `alembic/env.py`
3. Run `alembic revision --autogenerate -m "Add new_table"`

### Modifying Existing Columns

```python
# Example: Making email column non-nullable with default
def upgrade() -> None:
    # First, set a default value for existing NULL emails
    op.execute("UPDATE users SET email = 'noemail@example.com' WHERE email IS NULL")
    # Then alter the column to be non-nullable
    op.alter_column('users', 'email', nullable=False)

def downgrade() -> None:
    op.alter_column('users', 'email', nullable=True)
```

### Data Migration

For complex data transformations, add custom logic:

```python
def upgrade() -> None:
    # Schema changes
    op.add_column('users', sa.Column('full_name_normalized', sa.String(), nullable=True))
    
    # Data transformation
    connection = op.get_bind()
    connection.execute(
        "UPDATE users SET full_name_normalized = LOWER(TRIM(full_name))"
    )
    
    # Make the new column non-nullable
    op.alter_column('users', 'full_name_normalized', nullable=False)
```

### Renaming Columns/Tables

```python
def upgrade() -> None:
    op.alter_column('users', 'username', new_column_name='login_name')

def downgrade() -> None:
    op.alter_column('users', 'login_name', new_column_name='username')
```

## Best Practices

1. **Always backup** your database before running migrations in production
2. **Test migrations** thoroughly in development first
3. **Review auto-generated code** - Alembic might not handle complex scenarios perfectly
4. **Use descriptive migration messages** that explain what the migration does
5. **Consider rollback scenarios** - ensure your `downgrade()` function works correctly
6. **Handle data migrations carefully** - consider the impact on existing data
7. **Use transactions** - migrations run in transactions by default, but be aware of DDL limitations
8. **Monitor migration performance** - large table alterations can be slow

## Troubleshooting

### Migration fails with "target database is not up to date"
```bash
# Check current migration status
alembic current
alembic history
# Upgrade to latest
alembic upgrade head
```

### Need to rollback a migration
```bash
# Rollback to specific revision
alembic downgrade <revision_id>
# Rollback one step
alembic downgrade -1
```

### Manual migration needed
```bash
# Create empty migration for manual changes
alembic revision -m "Manual data migration"
# Edit the generated file with custom logic
```